<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥å¸¸æ‰“å•å·¥å…·ï¼ˆå«æ´¾é¤å¯¼å‡ºä¸å¿«æ·æŒ‡ä»¤/AppleScriptï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:0 auto;padding:16px;background:#fafafa;line-height:1.4}
    h1{font-size:20px;margin:8px 0}
    h2{font-size:16px;margin:0 0 8px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .date-title{margin:4px 0 16px;color:#394150;font-size:16px;font-weight:600}
    input,select,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #ccc}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    .num{text-align:right}
    .btn{cursor:pointer;border:none;padding:8px 12px;border-radius:8px}
    .btn.primary{background:#0a7cff;color:#fff}
    .btn.warn{background:#ef4444;color:#fff}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .summary-text{margin:4px 0 0;color:#394150;font-size:14px;font-weight:500}
    .muted{color:#6b7280}
    .invoice-header{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .invoice-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:13px;color:#4b5563;margin-bottom:8px}
    .invoice-card table th,.invoice-card table td{font-size:13px}
    .invoice-empty{color:#9ca3af;text-align:center;padding:16px 0}
    .finance-card{border-color:#d1d5db;background:#f9fafb}
    .finance-card h2{display:flex;align-items:center;gap:6px}
    .finance-card .money{font-weight:600;color:#0f172a}
    .finance-card small{display:block;margin-top:6px;color:#9ca3af}
    .order-controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .order-controls select{flex:1 1 auto}
    .order-item-list{display:flex;flex-direction:column;gap:4px;margin:0;padding:0}
    .order-item{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#f3f4f6;padding:6px 8px;border-radius:8px;font-size:13px}
    .order-item .actions{display:flex;gap:6px}
    .order-item .label{flex:1 1 auto}
    .btn.tiny{padding:4px 6px;font-size:12px}
    .order-remark{color:#4b5563;font-size:13px}
    .order-remark.muted{color:#9ca3af}
    @media (max-width:640px){
      body{padding:12px}
      .card{padding:12px}
      .invoice-card table{font-size:13px}
      .invoice-card table th,.invoice-card table td{font-size:12px;padding:6px}
      .toolbar{flex-direction:column;align-items:stretch}
      .toolbar .btn{width:100%;text-align:center}
    }
  </style>
</head>
<body>
  <h1>æ—¥å¸¸æ‰“å•å·¥å…·ï¼ˆå«æ´¾é¤å¯¼å‡ºä¸å¿«æ·æŒ‡ä»¤/AppleScriptï¼‰</h1>
  <p class="date-title" id="dateTitle"></p>
  <div class="card" id="summaryCard">
    <h2>ä»Šæ—¥èœå“æ±‡æ€»</h2>
    <p class="summary-text muted" id="summaryText">æš‚æ— èœå“ï¼Œæ·»åŠ åè‡ªåŠ¨æ±‡æ€»ã€‚</p>
  </div>
  <div class="card">
    <label>åºå·</label>
    <div class="order-controls">
      <select id="orderSelect"></select>
      <button class="btn" type="button" id="newOrder">+ æ–°å»ºåºå·</button>
    </div>
    <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼Œå½“å‰åºå·ï¼‰</label>
    <input id="orderRemark" placeholder="ä¾‹å¦‚ï¼šåŠ è¾£ / ä¸è¦é¦™èœ" />
    <label>èœåï¼ˆå¯é€‰æ‹©æˆ–è‡ªè¡Œè¾“å…¥ï¼‰</label>
    <input list="presetItems" id="itemName" placeholder="ä¾‹å¦‚ï¼šä¸è¾£ä¸‰æ‹¼æˆ–è‡ªå®šä¹‰èœå" />
    <datalist id="presetItems">
      <option value="ä¸è¾£ä¸‰æ‹¼" data-price="15.99">ä¸è¾£ä¸‰æ‹¼ï¼ˆ15.99ï¼‰</option>
      <option value="è¾£ä¸‰æ‹¼" data-price="15.99">è¾£ä¸‰æ‹¼ï¼ˆ15.99ï¼‰</option>
      <option value="æ°´ç…®é±¼å¥—é¤" data-price="18.99">æ°´ç…®é±¼å¥—é¤ï¼ˆ18.99ï¼‰</option>
    </datalist>
    <label>å•ä»·ï¼ˆUSD ç¨åï¼‰</label>
    <input id="itemPrice" type="number" step="0.01" />
    <label>æ•°é‡</label>
    <input id="itemQty" type="number" min="1" value="1" />
    <button class="btn primary" id="addItem">+ æ·»åŠ </button>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>åºå·</th><th>èœå“</th><th>å¤‡æ³¨</th><th>æ•°é‡</th><th>é‡‘é¢</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="itemsBody"></tbody>
      <tfoot><tr><td colspan="4" class="num">åˆè®¡</td><td class="num" id="grandTotal">$0.00</td><td></td></tr></tfoot>
    </table>
    <div class="toolbar">
      <button class="btn primary" id="exportJSON">å¯¼å‡ºæ´¾é¤åˆ°å¿«æ·æŒ‡ä»¤ (.json)</button>
      <button class="btn primary" id="exportAppleScript">å¯¼å‡ºåˆ° macOS æé†’äº‹é¡¹ï¼ˆAppleScriptï¼‰</button>
      <button class="btn primary" id="printInvoice">ğŸ§¾ æ‰“å°å‘ç¥¨</button>
      <button class="btn warn" id="clearAll">æ¸…ç©º</button>
    </div>
  </div>
  <div class="card finance-card" id="financeCard" style="display:none">
    <h2>å†…éƒ¨ç»“ç®—</h2>
    <p>ä½£é‡‘ (15%)ï¼š<span class="money" id="commissionAmount">$0.00</span></p>
    <p>è½¬è€æ¿é‡‘é¢ï¼š<span class="money" id="netAmount">$0.00</span></p>
    <small>ä»…è‡ªå·±æŸ¥çœ‹ï¼Œä¸ä¼šå‡ºç°åœ¨å‘ç¥¨ä¸­</small>
  </div>
  <div class="card invoice-card" id="invoiceCard">
    <div class="invoice-header">
      <h2>ğŸ§¾ å‘ç¥¨é¢„è§ˆ</h2>
    </div>
    <div class="invoice-meta">
      <span id="invoiceDate"></span>
      <span id="invoiceSummary" class="muted"></span>
    </div>
    <table>
      <thead><tr><th>åºå·</th><th>èœå“</th><th>å¤‡æ³¨</th><th>æ•°é‡</th><th>é‡‘é¢</th></tr></thead>
      <tbody id="invoiceItemsBody"></tbody>
      <tfoot><tr><td colspan="4" class="num">åˆè®¡</td><td class="num" id="invoiceTotal">$0.00</td></tr></tfoot>
    </table>
  </div>

  <script>
    const orders=[];
    let orderSeq=1;
    const COMMISSION_RATE=0.15;
    const $=s=>document.querySelector(s);
    const fmtDate=d=>`${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`;
    const displayDate=()=>new Date().toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'});
    const escapeHTML=str=>str.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function initDateMeta(){
      const dateStr=displayDate();
      $('#dateTitle').textContent=`ä»Šæ—¥å¼€å•ï¼š${dateStr}`;
      $('#invoiceDate').textContent=`å¼€ç¥¨æ—¥æœŸï¼š${dateStr}`;
      document.title=`æ—¥å¸¸æ‰“å•å·¥å…·ï¼ˆå«æ´¾é¤å¯¼å‡ºä¸å¿«æ·æŒ‡ä»¤/AppleScriptï¼‰ - ${dateStr}`;
    }

    function createOrder(){
      const order={id:orderSeq++, remark:'', items:[]};
      orders.push(order);
      return order;
    }

    function findOrderById(rawId){
      const id=Number(rawId);
      return orders.find(order=>order.id===id)||null;
    }

    function getSelectedOrder(){
      const select=$('#orderSelect');
      if(!select||!select.value){ return orders[0]||null; }
      return findOrderById(select.value);
    }

    function populateOrderSelect(preferredId){
      const select=$('#orderSelect');
      if(!select)return;
      select.innerHTML=orders.map(order=>`<option value="${order.id}">åºå· ${order.id}</option>`).join('');
      if(!orders.length){
        select.value='';
        $('#orderRemark').value='';
        return;
      }
      const fallback=orders[orders.length-1].id;
      const targetId=orders.some(order=>order.id===preferredId)?preferredId:fallback;
      select.value=String(targetId);
      syncRemarkInput();
    }

    function syncRemarkInput(){
      const remarkInput=$('#orderRemark');
      if(!remarkInput)return;
      const order=getSelectedOrder();
      remarkInput.value=order?order.remark:'';
    }

    function getOrderTotals(order){
      const quantity=order.items.reduce((sum,item)=>sum+item.qty,0);
      const amount=order.items.reduce((sum,item)=>sum+item.price*item.qty,0);
      return {quantity,amount};
    }

    function getSummaryString(){
      const counter=new Map();
      orders.forEach(order=>{
        order.items.forEach(item=>{
          counter.set(item.name,(counter.get(item.name)||0)+item.qty);
        });
      });
      if(!counter.size)return '';
      return Array.from(counter.entries()).map(([name,qty])=>`${name} Ã—${qty}`).join(' / ');
    }

    function buildSequenceTasks(){
      const results=[];
      orders.forEach(order=>{
        const totalUnits=order.items.reduce((sum,item)=>sum+item.qty,0);
        if(totalUnits===0)return;
        let cursor=1;
        order.items.forEach(item=>{
          for(let i=0;i<item.qty;i++){
            let label=totalUnits>1?`${order.id}. ${cursor}/${totalUnits} ${item.name}`:`${order.id}. ${item.name}`;
            if(order.remark){
              label+=`ï¼ˆ${order.remark}ï¼‰`;
            }
            results.push({
              label,
              sequence:order.id,
              item:item.name,
              price:item.price,
              remark:order.remark,
              index:cursor,
              total:totalUnits
            });
            cursor++;
          }
        });
      });
      return results;
    }

    $('#presetItems').addEventListener('change',()=>{
      const val=$('#itemName').value.trim();
      const opt=[...$('#presetItems').options].find(option=>option.value===val);
      if(opt){ $('#itemPrice').value=opt.getAttribute('data-price'); }
    });

    $('#itemName').addEventListener('input',()=>{
      const val=$('#itemName').value.trim();
      const options=$('#presetItems').options;
      let found=null;
      for(const opt of options){ if(opt.value===val){found=opt;break;} }
      if(found){ $('#itemPrice').value=found.getAttribute('data-price'); }
    });

    function render(){
      const body=$('#itemsBody');
      if(!body)return;
      body.innerHTML='';
      let total=0;
      orders.forEach(order=>{
        const {quantity,amount}=getOrderTotals(order);
        total+=amount;
        const detailHTML=order.items.length
          ? `<div class="order-item-list">${
              order.items.map((item,idx)=>{
                const safeName=escapeHTML(item.name);
                return `<div class="order-item"><span class="label">${safeName}</span><span class="num">Ã—${item.qty} Â· $${item.price.toFixed(2)}</span><div class="actions"><button type="button" class="btn tiny del-item" data-order="${order.id}" data-item="${idx}">åˆ é™¤</button></div></div>`;
              }).join('')
            }</div>`
          : `<span class="muted">æš‚æ— èœå“</span>`;
        const remarkClass=order.remark?'order-remark':'order-remark muted';
        const remarkText=order.remark?escapeHTML(order.remark):'â€”';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${order.id}</td><td>${detailHTML}</td><td><span class="${remarkClass}">${remarkText}</span></td><td class="num">${quantity}</td><td class="num">$${amount.toFixed(2)}</td><td><button type="button" class="btn warn del-order" data-order="${order.id}">åˆ é™¤åºå·</button></td>`;
        body.appendChild(tr);
      });
      $('#grandTotal').textContent=`$${total.toFixed(2)}`;
      updateSummary(total);
    }

    document.body.addEventListener('click',e=>{
      if(e.target.classList.contains('del-item')){
        const orderId=Number(e.target.dataset.order);
        const itemIndex=Number(e.target.dataset.item);
        const targetOrder=findOrderById(orderId);
        if(targetOrder){
          targetOrder.items.splice(itemIndex,1);
          render();
        }
      }
      if(e.target.classList.contains('del-order')){
        const orderId=Number(e.target.dataset.order);
        const idx=orders.findIndex(order=>order.id===orderId);
        if(idx>-1 && confirm(`ç¡®å®šåˆ é™¤åºå· ${orderId} åŠå…¶èœå“å—ï¼Ÿ`)){
          orders.splice(idx,1);
          if(!orders.length){
            const order=createOrder();
            populateOrderSelect(order.id);
          }else{
            const nextOrder=orders[Math.min(idx,orders.length-1)];
            populateOrderSelect(nextOrder.id);
          }
          render();
        }
      }
    });

    $('#addItem').onclick=()=>{
      const order=getSelectedOrder();
      if(!order){ alert('è¯·å…ˆæ–°å»ºåºå·'); return; }
      const name=$('#itemName').value.trim();
      const price=Number($('#itemPrice').value)||0;
      const qty=Math.max(1,Number($('#itemQty').value)||1);
      if(!name)return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥èœå');
      order.items.push({name,price,qty});
      $('#itemName').value='';
      $('#itemPrice').value='';
      $('#itemQty').value=1;
      render();
    };

    $('#newOrder').addEventListener('click',()=>{
      const order=createOrder();
      populateOrderSelect(order.id);
      $('#orderRemark').focus();
      render();
    });

    $('#orderSelect').addEventListener('change',()=>{
      syncRemarkInput();
    });

    $('#orderRemark').addEventListener('input',e=>{
      const order=getSelectedOrder();
      if(order){
        order.remark=e.target.value.trim();
        render();
        e.target.value=order.remark;
      }
    });

    $('#clearAll').onclick=()=>{
      if(!confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨åºå·ä¸èœå“ï¼Ÿ'))return;
      orders.length=0;
      orderSeq=1;
      const order=createOrder();
      populateOrderSelect(order.id);
      render();
    };

    function updateSummary(total){
      initDateMeta();
      const summaryEl=$('#summaryText');
      const invoiceSummaryEl=$('#invoiceSummary');
      const invoiceBody=$('#invoiceItemsBody');
      const invoiceTotalEl=$('#invoiceTotal');
      const financeCard=$('#financeCard');
      const commissionEl=$('#commissionAmount');
      const netEl=$('#netAmount');
      const hasItems=orders.some(order=>order.items.length);
      if(!hasItems){
        summaryEl.textContent='æš‚æ— èœå“ï¼Œæ·»åŠ åè‡ªåŠ¨æ±‡æ€»ã€‚';
        summaryEl.classList.add('muted');
        invoiceSummaryEl.textContent='æš‚æ— èœå“';
        invoiceBody.innerHTML=`<tr><td colspan="5" class="invoice-empty">æš‚æ— èœå“</td></tr>`;
        invoiceTotalEl.textContent='$0.00';
        financeCard.style.display='none';
        return;
      }
      const summaryStr=getSummaryString();
      summaryEl.textContent=summaryStr;
      summaryEl.classList.remove('muted');
      invoiceSummaryEl.textContent=`æ±‡æ€»ï¼š${summaryStr}`;
      invoiceBody.innerHTML='';
      orders.forEach(order=>{
        if(!order.items.length)return;
        const {quantity,amount}=getOrderTotals(order);
        const detailHTML=order.items.map(item=>`<div>${escapeHTML(item.name)} Ã—${item.qty}</div>`).join('');
        const remarkText=order.remark?escapeHTML(order.remark):'â€”';
        const row=document.createElement('tr');
        row.innerHTML=`<td>${order.id}</td><td>${detailHTML}</td><td>${remarkText}</td><td class="num">${quantity}</td><td class="num">$${amount.toFixed(2)}</td>`;
        invoiceBody.appendChild(row);
      });
      invoiceTotalEl.textContent=`$${total.toFixed(2)}`;
      const commission=total*COMMISSION_RATE;
      const net=total-commission;
      commissionEl.textContent=`$${commission.toFixed(2)}`;
      netEl.textContent=`$${net.toFixed(2)}`;
      financeCard.style.display='block';
    }

    function generateJSON(){
      const tasks=buildSequenceTasks();
      if(!tasks.length){ alert('æš‚æ— èœå“'); return; }
      const now=new Date();
      const dateStr=fmtDate(now);
      const exportData={
        date:dateStr,
        generatedAt:now.toISOString(),
        orders:orders.filter(order=>order.items.length).map(order=>{
          const {quantity,amount}=getOrderTotals(order);
          return {
            sequence:order.id,
            remark:order.remark,
            totalQuantity:quantity,
            totalAmount:amount,
            items:order.items.map(item=>({
              name:item.name,
              price:item.price,
              quantity:item.qty
            }))
          };
        }),
        tasks:tasks.map(task=>({
          task:task.label,
          sequence:task.sequence,
          item:task.item,
          price:task.price,
          index:task.index,
          total:task.total,
          remark:task.remark,
          created:now.toISOString()
        }))
      };
      const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`æ´¾é¤æ¸…å•_${dateStr}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportAppleScript(){
      const tasks=buildSequenceTasks();
      if(!tasks.length){ alert('æš‚æ— èœå“'); return; }
      const listName='æ´¾é¤æ¸…å•';
      const esc=s=>s.replace(/\\/g,'\\\\').replace(/"/g,'\\"');
      const applescript=`-- ç”Ÿæˆäºç½‘é¡µï¼šæ—¥å¸¸æ‰“å•å·¥å…·
set theListName to "${esc(listName)}"
tell application "Reminders"
\tif not (exists list theListName) then
\t\tmake new list with properties {name:theListName}
\tend if
\tset targetList to list theListName
\trepeat with t in {${tasks.map(t=>`\"${esc(t.label)}\"`).join(', ')}}
\t\tmake new reminder at end of reminders of targetList with properties {name:(t as text)}
\tend repeat
\tactivate
end tell
display dialog "å·²åˆ›å»º ${tasks.length} æ¡æé†’åˆ°ã€${esc(listName)}ã€‘" buttons {"å¥½"} default button 1`;
      const blob=new Blob([applescript],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      const now=new Date();
      const dateStr=fmtDate(now);
      a.download=`æ´¾é¤æ¸…å•_${dateStr}.applescript`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function printInvoice(){
      const tasks=buildSequenceTasks();
      if(!tasks.length){ alert('æš‚æ— èœå“'); return; }
      const dateStr=displayDate();
      const summaryStr=getSummaryString();
      const rows=orders.map(order=>{
        if(!order.items.length)return '';
        const {quantity,amount}=getOrderTotals(order);
        const detail=order.items.map(item=>`${escapeHTML(item.name)} Ã—${item.qty} Â· $${item.price.toFixed(2)}`).join('<br>');
        const remark=order.remark?escapeHTML(order.remark):'â€”';
        return `<tr><td>${order.id}</td><td>${detail}</td><td>${remark}</td><td class="num">${quantity}</td><td class="num">$${amount.toFixed(2)}</td></tr>`;
      }).join('');
      const total=orders.reduce((sum,order)=>sum+getOrderTotals(order).amount,0);
      const invoiceHTML=`<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>å‘ç¥¨æ‰“å° - ${escapeHTML(dateStr)}</title>
<style>
*{box-sizing:border-box;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#f5f5f5;line-height:1.5;color:#111827;}
.page{max-width:420px;margin:0 auto;padding:24px 18px;background:#fff;min-height:100vh;}
h1{font-size:22px;margin:0 0 12px;}
.meta{font-size:13px;color:#4b5563;margin-bottom:18px;}
table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;}
th,td{border:1px solid #e5e7eb;padding:10px 8px;text-align:left;font-size:13px;}
.num{text-align:right;}
tfoot td{font-weight:600;}
@media (max-width:480px){
  .page{padding:20px 14px;}
  h1{font-size:20px;}
  .meta{font-size:12px;}
  th,td{padding:8px 6px;font-size:12px;}
}
@media print{
  body{background:#fff;}
  .page{max-width:none;padding:0;}
}
</style>
</head>
<body>
  <div class="page">
    <h1>ğŸ§¾ å¤–å–å‘ç¥¨</h1>
    <div class="meta">
      <div>å¼€ç¥¨æ—¥æœŸï¼š${escapeHTML(dateStr)}</div>
      <div>${summaryStr?`æ±‡æ€»ï¼š${escapeHTML(summaryStr)}`:''}</div>
    </div>
    <table>
      <thead><tr><th>åºå·</th><th>èœå“</th><th>å¤‡æ³¨</th><th>æ•°é‡</th><th>é‡‘é¢</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><td colspan="4" class="num">åˆè®¡</td><td class="num">$${total.toFixed(2)}</td></tr></tfoot>
    </table>
  </div>
</body>
</html>`;
      const printWin=window.open('','_blank','noopener=yes');
      if(!printWin){ alert('è¯·å…è®¸æµè§ˆå™¨å¼¹å‡ºçª—å£ä»¥æ‰“å°å‘ç¥¨'); return; }
      printWin.document.write(invoiceHTML);
      printWin.document.close();
      printWin.focus();
      setTimeout(()=>printWin.print(),100);
    }

    document.getElementById('exportJSON').addEventListener('click', generateJSON);
    document.getElementById('exportAppleScript').addEventListener('click', exportAppleScript);
    document.getElementById('printInvoice').addEventListener('click', printInvoice);

    createOrder();
    populateOrderSelect(orders[0].id);
    syncRemarkInput();
    initDateMeta();
    render();
  </script>
</body>
</html>
